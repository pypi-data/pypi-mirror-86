<snaplogic-javascript-output-html />
<script>
    console.log("Operation: Save Script")

    // Remove empty line generated by the display(HTML())
    var outputElements = document.getElementsByClassName("output_html");
    for (i = outputElements.length - 1; i >= 0; i--) {
        if (outputElements[i].children[0].tagName === "SNAPLOGIC-JAVASCRIPT-OUTPUT-HTML") {
            outputElements[i].parentElement.remove();
        }
    }

    var cells = IPython.notebook.get_cells();
    var i = 0;
    var script_header = '%s';
    var python_script = "";
    for (i = 0; i < cells.length; i++) {
        var firstLine = cells[i].get_text().split("\n")[0].trim();
        if (firstLine === script_header.trim()) {
            python_script = cells[i].get_text();
            break;
        }
    }


    python_script = python_script.trim().replace(script_header, "\n")

    function publish_callback() {
        document.getElementsByClassName("snaplogic-publish-btn")[0].click();
    }
    function publish_and_validate_callback() {
        document.getElementsByClassName("snaplogic-publish-and-validate-btn")[0].click();
    }
    function local_validate_callback() {
        document.getElementsByClassName("snaplogic-local-validate-btn")[0].click();
    }

    if (python_script.length > 0) {
        document.getElementById("script-tab").style.visibility = "visible";
        document.getElementById("script-tab").click();
        document.getElementById("snaplogic-script-box-value").innerText = python_script.trim();
        document.getElementsByClassName("snaplogic-publish-btn")[0].style.visibility = "visible";
        document.getElementsByClassName("snaplogic-publish-and-validate-btn")[0].style.visibility = "visible";
        if (document.getElementsByClassName("snaplogic-local-validate-btn")[0].style.visibility === "visible") {
            require(
                ["base/js/dialog"],
                function (dialog) {
                    dialog.modal({
                        title: "Script Saved",
                        body: "Please review the script before publish and/or validate.",
                        buttons: {
                            "Publish": {
                                class: "btn-primary",
                                click: publish_callback
                            },
                            "Cloud Validate": {
                                class: "btn-success",
                                click: publish_and_validate_callback
                            },
                            "Local Validate": {
                                class: "btn-info",
                                click: local_validate_callback
                            },
                            "Close": {
                            }
                        }
                    });
                }
            );
        } else {
            require(
                ["base/js/dialog"],
                function (dialog) {
                    dialog.modal({
                        title: "Script Saved",
                        body: "Please review the script before publish and/or validate.",
                        buttons: {
                            "Publish": {
                                class: "btn-primary",
                                click: publish_callback
                            },
                            "Cloud Validate": {
                                class: "btn-success",
                                click: publish_and_validate_callback
                            },
                            "Close": {
                            }
                        }
                    });
                }
            );
        }
    } else {
        document.getElementById("script-tab").style.visibility = "hidden";
        document.getElementById("snaplogic-input-tab").style.visibility = "hidden";
        document.getElementById("snaplogic-output-tab").style.visibility = "hidden";
        document.getElementById("snaplogic-error-tab").style.visibility = "hidden";
        document.getElementById("snaplogic-console-tab").style.visibility = "hidden";
        document.getElementById("snap-tab").click();
        document.getElementsByClassName("snaplogic-publish-btn")[0].style.visibility = "hidden";
        document.getElementsByClassName("snaplogic-publish-and-validate-btn")[0].style.visibility = "hidden";
        document.getElementsByClassName("snaplogic-local-validate-btn")[0].style.visibility = "hidden";
        require(
            ["base/js/dialog"],
            function (dialog) {
                dialog.modal({
                    title: "Script Not Found",
                    body: "Please verify that the header of the script cell is as the following:\n##### The first cell with this header will be saved and published. Do not remove or modify this header. #####",
                    buttons: {
                        "Close": {
                        }
                    }
                });
            }
        );
    }

    require(["https://s3.us-east-2.amazonaws.com/snaplogic-ds-public/4.15/jupyter_notebook_integration/highlight.min.js"], function (hljs) {
        hljs.highlightBlock(document.getElementById("snaplogic-script-box-value"));
    });

    var command = "sl.set_script(" + "'" + escape(python_script) + "')";
    var kernel = IPython.notebook.kernel;
    kernel.execute(command);

    document.getElementById("snaplogic-script-unwrap-button").click()

</script>