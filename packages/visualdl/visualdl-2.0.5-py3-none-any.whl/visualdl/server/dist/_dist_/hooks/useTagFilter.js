function B(e,n){if(e==null)return{};var s=C(e,n),t,r;if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++){if(t=o[r],n.indexOf(t)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(e,t))continue;s[t]=e[t]}}return s}function C(e,n){if(e==null)return{};var s={},t=Object.keys(e),r,o;for(o=0;o<t.length;o++){if(r=t[o],n.indexOf(r)>=0)continue;s[r]=e[r]}return s}function T(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,t)}return s}function i(e){for(var n=1;n<arguments.length;n++){var s=arguments[n]!=null?arguments[n]:{};n%2?T(Object(s),!0).forEach(function(t){x(e,t,s[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))})}return e}function x(e,n,s){return n in e?Object.defineProperty(e,n,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[n]=s,e}import{actions as N,selectors as _}from"../store/index.js";import{color as P,colorAlt as W}from"../utils/chart.js";import{useCallback as I,useEffect as m,useMemo as f,useReducer as k}from"../../web_modules/react.js";import{useDispatch as A,useSelector as F}from"../../web_modules/react-redux.js";import{cache as K}from"../../web_modules/swr.js";import Q from"../../web_modules/lodash/groupBy.js";import U from"../../web_modules/lodash/intersection.js";import Y from"../../web_modules/lodash/intersectionBy.js";import G from"../../web_modules/lodash/uniq.js";import H from"./useQuery.js";import{useRunningRequest as M}from"./useRequest.js";var a;(function(e){e[e.initRuns=0]="initRuns",e[e.setRuns=1]="setRuns",e[e.setSelectedRuns=2]="setSelectedRuns",e[e.initTags=3]="initTags",e[e.setTags=4]="setTags",e[e.setSelectedTags=5]="setSelectedTags"})(a||(a={}));const v=(e,n)=>Object.entries(Q(e.filter(s=>!!e.find(t=>t.label===s.label)).reduce((s,t)=>(n&&n[t.label]&&Array.prototype.push.apply(s,n[t.label].map(r=>({label:r,run:t}))),s),[]),s=>s.label)).map(([s,t])=>({label:s,runs:t.map(r=>r.run)})),V=e=>e==null?void 0:e.map((n,s)=>{const t=s%P.length;return{label:n,colors:[P[t],W[t]]}}),z=(e,n)=>{switch(n.type){case a.initRuns:{const s=n.payload,t=s.length?U(s,e.globalRuns):e.globalRuns,r=t.length?t:s,o=V(s),b=o.filter(w=>r.includes(w.label)),R=v(b,e.initTags);return i(i({},e),{},{initRuns:s,globalRuns:r,runs:o,selectedRuns:b,tags:R,selectedTags:R})}case a.setRuns:{const s=n.payload,t=Y(e.selectedRuns,s,o=>o.label),r=v(t,e.initTags);return i(i({},e),{},{runs:s,selectedRuns:t,tags:r,selectedTags:r})}case a.setSelectedRuns:{const s=n.payload,t=s.map(o=>o.label),r=v(s,e.initTags);return i(i({},e),{},{globalRuns:t,selectedRuns:s,tags:r,selectedTags:r})}case a.initTags:{const s=n.payload,t=v(e.selectedRuns,s);return i(i({},e),{},{initTags:s,tags:t,selectedTags:t})}case a.setTags:{const s=n.payload;return i(i({},e),{},{tags:s,selectedTags:s})}case a.setSelectedTags:{const s=n.payload;return i(i({},e),{},{selectedTags:s})}default:throw new Error}},J=(e,n)=>{const s=H(),{data:t,loading:r,error:o}=M(`/${e}/tags`,n);m(()=>()=>K.delete(`/${e}/tags`),[e]);const b=A(),R=f(()=>_.runs.getRunsByPage(e),[e]),w=F(R),y=f(()=>{var l;return(l=t==null?void 0:t.runs)!==null&&l!==void 0?l:[]},[t]),d=f(()=>t?y.reduce((l,u,O)=>{if(l[u]){var g,p;l[u]=[...l[u],...(g=(p=t.tags)===null||p===void 0?void 0:p[O])!==null&&g!==void 0?g:[]]}else{var S;l[u]=(S=t.tags[O])!==null&&S!==void 0?S:[]}return l},{}):{},[y,t]),[c,h]=k(z,{initRuns:[],globalRuns:w,runs:[],selectedRuns:[],initTags:{},tags:[],selectedTags:[]}),j=f(()=>s.runs?G(Array.isArray(s.runs)?s.runs:s.runs.split(",")):[],[s]),L=I(l=>h({type:a.setSelectedRuns,payload:l}),[]),D=I(l=>h({type:a.setSelectedTags,payload:l}),[]);m(()=>h({type:a.initRuns,payload:y||[]}),[y]),m(()=>h({type:a.initTags,payload:d||{}}),[d]),m(()=>{if(j.length){const l=c.runs.filter(u=>j.includes(u.label));h({type:a.setSelectedRuns,payload:l.length?l:c.runs})}},[j,c.runs]),m(()=>{b(N.runs.setSelectedRuns(e,c.globalRuns))},[b,c.globalRuns,e]);const E=f(()=>c.tags.reduce((l,u)=>{let{runs:O}=u,g=B(u,["runs"]);return Array.prototype.push.apply(l,O.map(p=>i(i({},g),{},{run:p,id:`${g.label}-${p.label}`}))),l},[]),[c.tags]),q=f(()=>c.selectedRuns.filter(l=>{var u;return!!(d==null||((u=d[l.label])===null||u===void 0)?void 0:u.length)}),[c.selectedRuns,d]);return i(i({},c),{},{tagsWithSingleRun:E,runsInTags:q,onChangeRuns:L,onChangeTags:D,loading:r,error:o})};export default J;
