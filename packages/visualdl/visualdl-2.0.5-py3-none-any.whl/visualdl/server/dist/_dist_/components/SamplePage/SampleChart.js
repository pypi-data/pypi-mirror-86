function F(e,r){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);r&&(l=l.filter(function(_){return Object.getOwnPropertyDescriptor(e,_).enumerable})),i.push.apply(i,l)}return i}function W(e){for(var r=1;r<arguments.length;r++){var i=arguments[r]!=null?arguments[r]:{};r%2?F(Object(i),!0).forEach(function(l){te(e,l,i[l])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):F(Object(i)).forEach(function(l){Object.defineProperty(e,l,Object.getOwnPropertyDescriptor(i,l))})}return e}function te(e,r,i){return r in e?Object.defineProperty(e,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[r]=i,e}import a,{useCallback as B,useEffect as P,useMemo as v,useRef as E,useState as O}from"../../../web_modules/react.js";import{ellipsis as G,em as C,primaryColor as re,rem as f,size as ne,transitionProps as K}from"../../utils/style.js";import oe from"../ChartToolbox.js";import ie from"../../../web_modules/react-spinners/GridLoader.js";import le from"./StepSlider.js";import{fetcher as se}from"../../utils/fetch.js";import{formatTime as ae}from"../../utils/index.js";import V from"../../../web_modules/lodash/isEmpty.js";import ce from"../../../web_modules/mime-types.js";import Y from"../../../web_modules/query-string.js";import{saveAs as me}from"../../../web_modules/file-saver.js";import S from"../../../web_modules/styled-components.js";import ue from"../../hooks/useRequest.js";import{useRunningRequest as de}from"../../hooks/useRequest.js";import{useTranslation as pe}from"../../../web_modules/react-i18next.js";const fe=S.div.withConfig({displayName:"SampleChart__Wrapper",componentId:"sc-19m7v01-0"})(["height:100%;padding:",";padding-bottom:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;> *{flex-grow:0;flex-shrink:0;}"],C(20)),_e=S.div.withConfig({displayName:"SampleChart__Title",componentId:"sc-19m7v01-1"})(["display:flex;justify-content:space-between;align-items:center;margin-bottom:",";> h4{font-size:",";font-weight:700;flex-shrink:1;flex-grow:1;padding:0;margin:0;","}> span{font-size:",";flex-shrink:0;flex-grow:0;color:var(--text-light-color);"," max-width:50%;"," &::before{content:'';display:inline-block;"," margin-right:",";border-radius:",";vertical-align:middle;background-color:",";}}"],C(20),C(16),G(),C(14),G(),K("color"),ne(f(5),f(17)),f(8),f(2.5),e=>e.color),he=S.div.withConfig({displayName:"SampleChart__Container",componentId:"sc-19m7v01-2"})(["flex-grow:1;flex-shrink:1;margin:"," 0;display:flex;justify-content:center;align-items:center;overflow:hidden;cursor:",";"],C(20),e=>e.preview?"zoom-in":"default"),ge=S.div.withConfig({displayName:"SampleChart__Footer",componentId:"sc-19m7v01-3"})(["margin-bottom:",";display:flex;align-items:center;justify-content:space-between;"],f(18)),we=S.div.withConfig({displayName:"SampleChart__FooterInfo",componentId:"sc-19m7v01-4"})(["color:var(--text-lighter-color);font-size:",";"," > *{display:inline-block;margin-left:",";}"],f(12),K("color"),f(10)),ye=(e,r,i,l,_)=>`/${e}/${e}?${Y.stringify({index:r,ts:_,run:i,tag:l})}`,be=({run:e,tag:r,running:i,type:l,cache:_,footer:H,content:T,previewer:j})=>{const{t:h,i18n:M}=pe(["sample","common"]),{data:o,error:U,loading:k}=de(`/${l}/list?${Y.stringify({run:e.label,tag:r})}`,!!i),u=v(()=>{var t;return(t=o==null?void 0:o.map(s=>s.step))!==null&&t!==void 0?t:[]},[o]),[R,L]=O(!1),[n,x]=O(0),[g,A]=O(),c=E({}),y=E(null),$=E(null);P(()=>{const t=s=>{const ee=document.querySelectorAll(":hover");(R||Array.from(ee).some(m=>m.isSameNode($.current)))&&(s.key==="ArrowLeft"||s.key==="ArrowUp"?(x(m=>m>0?m-1:m),s.preventDefault()):(s.key==="ArrowRight"||s.key==="ArrowDown")&&(x(m=>m<u.length-1?m+1:m),s.preventDefault()))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[u,R]),P(()=>{Object.values(c.current).forEach(({timer:t})=>clearTimeout(t)),c.current={}},[r,e]);const b=v(()=>{var t;return(t=o==null?void 0:o[n].wallTime)!==null&&t!==void 0?t:0},[o,n]),w=B(()=>{if(!o)return;const t=ye(l,n,e.label,r,b);c.current[n]={src:t,timer:setTimeout(()=>{(s=>delete c.current[s])(n)},_)},A(t),y.current=null},[l,n,e.label,r,b,o,_]);P(()=>{if(c.current[n])A(c.current[n].src);else if(V(c.current))w();else return y.current=setTimeout(w,500),()=>{y.current!=null&&(clearTimeout(y.current),y.current=null)}},[n,w]);const[N,J]=O(!1),I=E(null),D=E(new IntersectionObserver(t=>{if(t[0].intersectionRatio>0){var s;J(!0),(s=D.current)===null||s===void 0||s.disconnect()}}));P(()=>{const t=D.current;if(I.current&&t)return t.observe(I.current),()=>t.disconnect()},[]);const{data:d,error:q,loading:z}=ue(g!=null?g:null,se,{dedupingInterval:5*60*1e3}),Q=B(()=>{if(d){const t=d.type?ce.extension(d.type):null;me(d.data,`${e.label}-${r}-${u[n]}-${b.toString().replace(/\./,"_")}`.replace(/[/\\?%*:|"<>]/g,"_")+(t?`.${t}`:""))}},[d,e.label,r,u,n,b]),p=v(()=>{if(g)return{data:d,error:q,loading:z}},[g,d,q,z]),X=v(()=>k||!c.current[n]||!N?a.createElement(ie,{color:re,size:"10px"}):!o&&U?a.createElement("span",null,h("common:error")):V(o)?a.createElement("span",null,h("common:empty")):p?T(p):null,[N,k,U,o,n,p,h,T]),Z=v(()=>j&&(R&&p)?j(W(W({},p),{},{loading:!c.current[n]||p.loading,steps:u,step:n,onClose:()=>L(!1),onChange:x,onChangeComplete:w})):null,[j,p,R,u,n,w]);return a.createElement(fe,{ref:$},a.createElement(_e,{color:e.colors[0]},a.createElement("h4",null,r),a.createElement("span",null,e.label)),a.createElement(le,{value:n,steps:u,onChange:x,onChangeComplete:w},ae(b,M.language)),a.createElement(he,{ref:I,preview:!!j&&!!g,onClick:()=>L(!0)},X),Z,a.createElement(ge,null,a.createElement(oe,{items:[{icon:"download",tooltip:h(`sample:download-${l}`),onClick:Q}]}),a.createElement(we,null,a.createElement("span",null,h("sample:sample"),h("common:colon"),(o==null?void 0:o.length)?`${n+1}/${o.length}`:"--/--"),H)))};export default be;
