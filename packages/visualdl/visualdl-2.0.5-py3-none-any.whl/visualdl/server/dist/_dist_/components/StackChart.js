function de(t,l){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);l&&(s=s.filter(function(d){return Object.getOwnPropertyDescriptor(t,d).enumerable})),o.push.apply(o,s)}return o}function pe(t){for(var l=1;l<arguments.length;l++){var o=arguments[l]!=null?arguments[l]:{};l%2?de(Object(o),!0).forEach(function(s){Oe(t,s,o[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):de(Object(o)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(o,s))})}return t}function Oe(t,l,o){return l in t?Object.defineProperty(t,l,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[l]=o,t}function fe(t,l){if(t==null)return{};var o=je(t,l),s,d;if(Object.getOwnPropertySymbols){var h=Object.getOwnPropertySymbols(t);for(d=0;d<h.length;d++){if(s=h[d],l.indexOf(s)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(t,s))continue;o[s]=t[s]}}return o}function je(t,l){if(t==null)return{};var o={},s=Object.keys(t),d,h;for(h=0;h<s.length;h++){if(d=s[h],l.indexOf(d)>=0)continue;o[d]=t[d]}return o}import*as C from"../utils/chart.js";import I,{useCallback as b,useEffect as A,useImperativeHandle as _e,useMemo as q,useRef as V,useState as J}from"../../web_modules/react.js";import{primaryColor as Ee,transitionProps as Ie}from"../utils/style.js";import Le,{Wrapper as Se,useChartTheme as Re}from"../hooks/useECharts.js";import Te from"../../web_modules/react-spinners/GridLoader.js";import ke from"../../web_modules/lodash/defaultsDeep.js";import Ae from"../../web_modules/styled-components.js";import Ne from"../hooks/useThrottleFn.js";const De=Ae.div.withConfig({displayName:"StackChart__Tooltip",componentId:"sc-1xrpgve-0"})(["position:absolute;z-index:1;background-color:var(--tooltip-background-color);color:var(--tooltip-text-color);border-radius:4px;padding:5px;display:none;",""],Ie(["color","background-color"])),ze=I.forwardRef(({options:t,data:l,title:o,loading:s,zoom:d,className:h,onInit:N},me)=>{var F,U;const Q=l!=null?l:{minZ:0,maxZ:0,minY:0,maxY:0,minX:0,maxX:0,data:null},{minZ:W,maxZ:$,minY:y,maxY:P,minX:ee,maxX:te}=Q,ne=fe(Q,["minZ","maxZ","minY","maxY","minX","maxX"]),w=q(()=>{var e;return(e=ne.data)!==null&&e!==void 0?e:[]},[ne.data]),O=q(()=>y===0&&P===0?-.4:y-(P-y)*.4,[y,P]),j=b((e,n,r,a)=>{const i=a([e,n]);return i?(i[1]-=(r-W)/($-W)*(a([0,y])[1]-a([0,O])[1]),i):[0,0]},[W,$,y,O]),D=b((e,n,r)=>{const a=[];let i=0;for(;w[e]&&i<w[e].length;){const c=n(i++),v=n(i++),m=n(i++);m!==1&&i===3&&a.push(j(c,v,1,r)),a.push(j(c,v,m,r)),m!==1&&i===w[e].length&&a.push(j(c,v,1,r))}return a},[j,w]),ie=b((e,n)=>{const r=D(e.dataIndex,n.value,n.coord);return{type:"polygon",silent:!0,z:n.value(1),shape:{points:r},style:n.style({stroke:C.xAxis.axisLine.lineStyle.color,lineWidth:1})}},[D]),[x,oe]=J(null),[_,Z]=J([]),g=V(null),[ve,re]=J(""),X=V(x),le=V(_);A(()=>{X.current=x},[x]),A(()=>{le.current=_},[_]);const L=t==null||((F=t.axisPointer)===null||F===void 0||((U=F.label)===null||U===void 0))?void 0:U.formatter,se=b(e=>!L||X.current==null?"":typeof L=="string"?L:L(e,le.current[X.current]),[L]),ae=Re(),f=q(()=>{const{color:e,colorAlt:n,toolbox:r,series:a}=C,i=fe(C,["color","colorAlt","toolbox","series"]);return ke({title:{text:o!=null?o:""},visualMap:{min:y,max:P},axisPointer:{label:{formatter:se}},xAxis:{min:ee,max:te,axisPointer:{type:"none"}},yAxis:{inverse:!0,position:"right",min:O,max:P,axisLine:{onZero:!1},axisLabel:{formatter:c=>c<y?"":c+""},axisPointer:{type:"none"}},grid:{left:i.grid.right,right:i.grid.left},tooltip:{trigger:"none",showContent:!1,axisPointer:{axis:"y",snap:!1}},series:[pe(pe({},a),{},{type:"custom",silent:!0,data:w,renderItem:ie})]},t,ae,i)},[t,o,ae,w,ee,te,y,P,O,ie,se]),S=b(()=>{var e;oe(null),Z([]),((e=f.tooltip)===null||e===void 0?void 0:e.formatter)&&(re(""),g.current&&(g.current.style.display="none"))},[f.tooltip]),he=b((e,n)=>{try{var r,a,i,c;if(!e||!n)return;const{offsetX:E,offsetY:M}=n;if((r=M<O+f.grid.top)!==null&&r!==void 0?r:0){S();return}const[Pe,we]=e.convertFromPixel("grid",[E,M]),H=(a=(i=e.getOption().series)===null||i===void 0?void 0:i[0].data)!==null&&a!==void 0?a:[],B=H.map(p=>p[1]).sort((p,T)=>p-T);let G=0,R=null;for(;G<B.length;)if(we<=B[G++]){R=B[G-1];break}const K=R==null?null:H.findIndex(p=>p[1]===R);oe(K);let Y=[];if(R==null||(Y=H.map(p=>{const T=[p[0],p[1],p[2]];let ce=Number.POSITIVE_INFINITY;for(let k=0;k<p.length;k+=3){const ue=Math.abs(p[k]-Pe);ue<ce&&(ce=ue,T[0]=p[k],T[2]=p[k+2])}return T})),Z(Y),(c=f.tooltip)===null||c===void 0?void 0:c.formatter){var v,m;re(K==null?"":(v=f.tooltip)===null||v===void 0||((m=v.formatter)===null||m===void 0)?void 0:m.call(v,Y[K])),g.current&&(R==null?g.current.style.display="none":(g.current.style.left=`${E+10}px`,g.current.style.top=`${M+10}px`,g.current.style.display="block"))}}catch(E){S()}},[S,O,f.grid,f.tooltip]),z=Ne(he,{wait:200}),ye=b(e=>{try{const n=e.getZr();n&&(n.on("mousemove",r=>z.run(e,r)),n.on("mouseout",()=>{z.cancel(),S()}))}catch(n){z.cancel()}N==null||N(e)},[N,z,S]),{ref:ge,echart:u,wrapper:xe,saveAsImage:be}=Le({loading:!!s,zoom:d,autoFit:!0,onInit:ye});return _e(me,()=>({saveAsImage:()=>{be(o)}})),A(()=>{u==null||u.setOption(f,{notMerge:!0})},[u,f]),A(()=>{if(u)try{if(x==null)u.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"remove"}]}});else{var e,n;const r=(e=(n=u.getOption().series)===null||n===void 0?void 0:n[0].data)!==null&&e!==void 0?e:[],a=c=>u.convertToPixel("grid",c),i=c=>r[x][c];u.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"replace",silent:!0,cursor:"default",zlevel:1,z:1,shape:{points:D(x,i,a)}}]}})}}catch(r){}},[x,u,D]),A(()=>{if(u)try{if(_.length){const i=c=>u.convertToPixel("grid",c);u.setOption({graphic:{elements:_.map((c,v)=>{var m;const E=j(c[0],c[1],c[2],i);return{type:"circle",id:`dot${v}`,$action:"replace",cursor:"default",zlevel:1,z:2,shape:{cx:E[0],cy:E[1],r:3},style:{fill:"#fff",stroke:(m=f.color)===null||m===void 0?void 0:m[0],lineWidth:2}}})}})}else{var e,n,r,a;u.setOption({graphic:{elements:(e=u.getOption())===null||e===void 0||((n=e.graphic)===null||n===void 0||((r=n[0])===null||r===void 0||((a=r.elements)===null||a===void 0)))?void 0:a.filter(i=>i.id.startsWith("dot")).map(i=>({id:i.id,type:"circle",$action:"remove"}))}})}}catch(i){}},[_,u,f.color,j]),I.createElement(Se,{ref:xe,className:h},!u&&I.createElement("div",{className:"loading"},I.createElement(Te,{color:Ee,size:"10px"})),I.createElement("div",{className:"echarts",ref:ge}),I.createElement(De,{className:"tooltip",ref:g,dangerouslySetInnerHTML:{__html:ve}}))});export default ze;
