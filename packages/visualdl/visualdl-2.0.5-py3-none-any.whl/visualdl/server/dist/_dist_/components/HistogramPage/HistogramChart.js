function H(i,o){var n=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);o&&(r=r.filter(function(v){return Object.getOwnPropertyDescriptor(i,v).enumerable})),n.push.apply(n,r)}return n}function W(i){for(var o=1;o<arguments.length;o++){var n=arguments[o]!=null?arguments[o]:{};o%2?H(Object(n),!0).forEach(function(r){te(i,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(n)):H(Object(n)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(n,r))})}return i}function te(i,o,n){return o in i?Object.defineProperty(i,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[o]=n,i}import re from"../LineChart.js";import{Modes as l,options as oe,transform as ie}from"../../resource/histogram/index.js";import d,{useCallback as q,useEffect as ne,useMemo as c,useRef as se,useState as U}from"../../../web_modules/react.js";import ae from"../StackChart.js";import{rem as P,size as Y}from"../../utils/style.js";import le from"../ChartToolbox.js";import{distance as me}from"../../utils/index.js";import ce from"../../utils/event.js";import{fetcher as ue}from"../../utils/fetch.js";import{format as F}from"../../../web_modules/d3-format.js";import de from"../../../web_modules/lodash/minBy.js";import fe from"../../../web_modules/query-string.js";import f from"../../../web_modules/styled-components.js";import pe from"../../hooks/useHeavyWork.js";import{useRunningRequest as he}from"../../hooks/useRequest.js";import ve from"../../hooks/useThrottleFn.js";import{useTranslation as ge}from"../../../web_modules/react-i18next.js";import ye from"../../utils/wasm.js";const X=F(".4f"),Z=F(".4"),xe=()=>ye("histogram_transform").then(i=>o=>i(o.data,o.mode)),_e=f.div.withConfig({displayName:"HistogramChart__Wrapper",componentId:"sc-1nqqqkz-0"})([""," display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;"],Y("100%","100%")),we=f(re).withConfig({displayName:"HistogramChart__StyledLineChart",componentId:"sc-1nqqqkz-1"})(["flex-grow:1;"]),be=f(ae).withConfig({displayName:"HistogramChart__StyledStackChart",componentId:"sc-1nqqqkz-2"})(["flex-grow:1;"]),Oe=f(le).withConfig({displayName:"HistogramChart__Toolbox",componentId:"sc-1nqqqkz-3"})(["margin-left:",";margin-right:",";margin-bottom:",";"],P(20),P(20),P(18)),je=f.div.withConfig({displayName:"HistogramChart__Error",componentId:"sc-1nqqqkz-4"})([""," display:flex;justify-content:center;align-items:center;"],Y("100%","100%")),Ce=({cid:i,run:o,tag:n,mode:r,running:v})=>{const{t:u}=ge(["histogram","common"]),g=se(null),{data:p,error:B,loading:y}=he(`/histogram/list?${fe.stringify({run:o.label,tag:n})}`,!!v,ue,{refreshInterval:60*1e3}),[k,M]=U(!1),V=q(()=>{ce.emit("toggle-chart-size",i,!k),M(t=>!t)},[i,k]),x=c(()=>`${n} (${o.label})`,[n,o.label]),$=c(()=>({data:p!=null?p:[],mode:r}),[p,r]),s=pe(xe,null,ie,$),[m,_]=U(null);ne(()=>_(null),[r]);const w=c(()=>{if(r===l.Overlay)return s==null?void 0:s.data.map((e,a)=>({name:`${u("common:time-mode.step")}${e[0][1]}`,data:e,lineStyle:{color:o.colors[a===m||m==null?0:1]},z:a===m?s==null?void 0:s.data.length:a,encode:{x:[2],y:[3]}}));if(r===l.Offset){var t;const e=s;return{minX:e==null?void 0:e.minX,maxX:e==null?void 0:e.maxX,minY:e==null?void 0:e.minStep,maxY:e==null?void 0:e.maxStep,minZ:e==null?void 0:e.minZ,maxZ:e==null?void 0:e.maxZ,data:(t=e==null?void 0:e.data)!==null&&t!==void 0?t:[]}}return null},[s,r,o,m,u]),E=c(()=>({[l.Overlay]:t=>{var e;if(!s||m==null)return"";const a=t.find(h=>h.data[1]===s.data[m][0][1]);return(e=a==null?void 0:a.seriesName)!==null&&e!==void 0?e:""},[l.Offset]:t=>t[2]}),[m,s]),T=c(()=>({[l.Overlay]:t=>t.axisDimension==="x"?X(t.value):t.axisDimension==="y"?Z(t.value):"",[l.Offset]:(t,e)=>t.axisDimension==="x"?X(e==null?void 0:e[0]):t.axisDimension==="y"?Z(e==null?void 0:e[1]):""}),[]),b=c(()=>W(W({},oe[r]),{},{color:[o.colors[0]],tooltip:{formatter:E[r]},axisPointer:{label:{formatter:T[r]}},xAxis:{axisPointer:{snap:r===l.Overlay}},yAxis:{axisPointer:{snap:r===l.Overlay}}}),[r,o,E,T]),K=q((t,{offsetX:e,offsetY:a})=>{const h=t.getOption().series,J=[e,a];if(h){var j;const Q=h.map((S,N)=>{var I;return(I=S.data)===null||I===void 0?void 0:I.reduce((R,[,,L,D])=>{const ee=t.convertToPixel("grid",[L,D]),A=me(ee,J);return A<R[2]?[L,D,A,N]:R},[0,0,Number.POSITIVE_INFINITY,N])}),C=de(Q,S=>S[2]);_((j=C==null?void 0:C[3])!==null&&j!==void 0?j:null);return}},[]),O=ve(K,{wait:200}),z=q(t=>{const e=t.getZr();e&&(e.on("mousemove",a=>O.run(t,a)),e.on("mouseout",()=>{O.cancel(),_(null)}))},[O]),G=c(()=>r===l.Overlay?d.createElement(we,{ref:g,title:x,data:w,options:b,loading:y,onInit:z}):r===l.Offset?d.createElement(be,{ref:g,title:x,data:w,options:b,loading:y}):null,[w,y,r,b,x,z]);return!s&&B?d.createElement(je,null,u("common:error")):d.createElement(_e,null,G,d.createElement(Oe,{items:[{icon:"maximize",activeIcon:"minimize",tooltip:u("histogram:maximize"),activeTooltip:u("histogram:minimize"),toggle:!0,onClick:V},{icon:"download",tooltip:u("histogram:download-image"),onClick:()=>{var t;return(t=g.current)===null||t===void 0?void 0:t.saveAsImage()}}]}))};export default Ce;
