

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Administration &mdash; Benji Backup 0.11.0+dirty documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/asciinema/asciinema-player.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/asciinema/asciinema-player.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Containerized Benji" href="container.html" />
    <link rel="prev" title="Storage Statistics" href="statistics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Benji Backup
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#fedora-27-and-up">Fedora 27 and up</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#opensuse">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#rhel-centos-7">RHEL/CentOS 7</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ubuntu-16-04">Ubuntu 16.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#common-to-all-distributions">Common to All Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ceph-rbd-support">Ceph RBD Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#some-vocabulary">Some Vocabulary</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#backup">Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#deep-scrub-and-scrub">Deep Scrub and Scrub</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#restore">Restore</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#version-removal-and-cleanup">Version Removal and Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-file-location">Configuration File Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#top-level-configuration-directives">Top-level configuration directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-i-o-configurations">List of I/O Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-transform-configurations">List of Transform Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-storage-configurations">List of Storage Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#i-o-modules">I/O Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-file">I/O Module file</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-rbd">I/O Module rbd</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-rbdaio">I/O Module rbdaio</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-iscsi">I/O Module iscsi</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#transform-modules">Transform Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-zstd">Transform Module zstd</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-aes-256-gcm">Transform Module aes_256_gcm</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-aes-256-gcm-ecc">Transform Module aes_256_gcm_ecc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#storage-modules">Storage Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#hmac">HMAC</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#read-cache">Read Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-file">Storage Module file</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-s3">Storage Module s3</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-b2">Storage Module b2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#nbd">NBD</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#multiple-instance-installations">Multiple Instance Installations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backup.html">Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="backup.html#simple-backup">Simple Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#versions">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#differential-backup">Differential Backup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="backup.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#specifying-a-block-size">Specifying a block size</a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#labeling-versions">Labeling <em>Versions</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="backup.html#the-hints-file">The Hints File</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scrub.html">Scrub</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#reasons-for-scrubbing">Reasons for Scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-methods">Scrubbing Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-and-checksum">Consistency and Checksum</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#using-the-backup-source">Using the Backup Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-only">Consistency Only</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#batch-scrubbing">Batch scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-failures">Scrubbing Failures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="restore.html">Restore</a><ul>
<li class="toctree-l2"><a class="reference internal" href="restore.html#restoring">Restoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="restore.html#restoring-without-a-database">Restoring without a database</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#nbd-server">NBD Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="restore.html#known-issues-with-nbd-client">Known Issues with nbd-client</a></li>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-only-mount">Read-Only Mount</a></li>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-write-mount">Read-Write Mount</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#restoring-invalid-versions">Restoring Invalid <em>Versions</em></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="enforce.html">Retention Policy Enforcement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="enforce.html#policy-specification">Policy Specification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cleanup.html">Cleanup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#removing-old-versions">Removing old versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#id1">Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="statistics.html">Storage Statistics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="statistics.html#id1">Storage Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="statistics.html#space-usage-statistics">Space Usage Statistics</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Administration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#securing-version-metadata">Securing Version Metadata</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#backups-and-exports">Backups and Exports</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-high-availability">Database High-Availability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#securing-block-data-on-storages">Securing Block Data on Storages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#monitoring">Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general-advise">General Advise</a></li>
<li class="toctree-l3"><a class="reference internal" href="#machine-output">Machine output</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="container.html">Containerized Benji</a><ul>
<li class="toctree-l2"><a class="reference internal" href="container.html#images">Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="container.html#benji">benji</a></li>
<li class="toctree-l3"><a class="reference internal" href="container.html#benji-k8s">benji-k8s</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="container.html#helm-charts">Helm Charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="container.html#id1">benji-k8s</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="filter_expressions.html">Filter Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="datalayout.html">Data Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#database-backend">Database Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#block-storages">Block Storages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="support.html#issue-tracker">Issue Tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#security">Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="licenses.html">Licenses</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Benji Backup</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Administration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/administration.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="administration">
<span id="id1"></span><h1>Administration<a class="headerlink" href="#administration" title="Permalink to this headline">¶</a></h1>
<p>Benji is an important tool when it’s responsible for keeping backups of your important data. Backups, scrubs,
restores and cleanups must run smoothly and need to be monitored closely. Also, the database backend and the
collection of data storages need to meet your availability requirements.</p>
<div class="section" id="securing-version-metadata">
<h2>Securing Version Metadata<a class="headerlink" href="#securing-version-metadata" title="Permalink to this headline">¶</a></h2>
<p>This section shows methods of how to keep version metadata safe even when disaster happens.</p>
<div class="section" id="backups-and-exports">
<h3>Backups and Exports<a class="headerlink" href="#backups-and-exports" title="Permalink to this headline">¶</a></h3>
<p>Benji already writes a backup of a <em>version</em>’s metadata to the same storage as the block data automatically.
This backup can be restored with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">metadata-restore</span></code>:</p>
<p>The database-less restore option also uses this backup to facilitate restores even when the database is unavailable.
Please see section <a class="reference internal" href="restore.html#database-less-restore"><span class="std std-ref">Restoring without a database</span></a>.</p>
<p>Further copies of the <em>version</em> metadata can be made with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">metadata-export</span></code>. These exports can be stored
somewhere safe and later be restored with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">metadata-import</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is advisable to compress the exports as the  JSON export format is quite redundant.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A <em>version</em>’s metadata can only be imported if a <em>version</em> with the same <em>version</em> UID  does not exist
in the database, yet.</p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>When you remove (<code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">rm</span></code>) <em>versions</em> from the database and then call <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">cleanup</span></code>,
the blocks containing the backed up data will be removed from storage. No <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">metadata-import</span></code> can
bring them back, because Benji’s metadata exports only contain information on how to assemble the blocks
and not the block data themselves.</p>
</div>
</div>
<div class="section" id="database-high-availability">
<h3>Database High-Availability<a class="headerlink" href="#database-high-availability" title="Permalink to this headline">¶</a></h3>
<p>An additional option against data loss is to replicate the SQL database. Please refer to the database documentation.
You should also have a regular database backup in place.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>DBMS replication only helps in the case when one server crashes or has a failure. It does not help
against software-bug related data loss or human error. So the automatic metadata backup and
<code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">metadata-export</span></code> are the only reliable options for long-term data safety.</p>
</div>
</div>
</div>
<div class="section" id="securing-block-data-on-storages">
<h2>Securing Block Data on Storages<a class="headerlink" href="#securing-block-data-on-storages" title="Permalink to this headline">¶</a></h2>
<p>It is advisable for a storage to be redundant and highly available. Most cloud providers have an SLA which
guarantees a certain level of availability. If the storage is self-managed, look into the redundancy and
high-availability options it provides like:</p>
<ul class="simple">
<li><p>RAID 1, 5 and 6</p></li>
<li><p>Redundancy options provided by distributed object stores like Ceph or Minio</p></li>
<li><p>DRBD</p></li>
<li><p>Data redundancy and replication mechanisms in filesystems like Btrfs or ZFS</p></li>
</ul>
<p>If a storage fails or is affected by data corruption, at best corrupted or incomplete restores are possible.</p>
<p>Benji also supports multiple storages so a backup can be made to more then one storage, so providing a level
of redundancy.</p>
</div>
<div class="section" id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">¶</a></h2>
<div class="section" id="general-advise">
<h3>General Advise<a class="headerlink" href="#general-advise" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>If anything goes wrong Benji exists with a non-zero exit code. Make sure to catch and report this is your scripts.</p></li>
<li><p>Benji writes all output including possible stack traces and command lines to the configured logfile
(see <a class="reference internal" href="configuration.html#configuration"><span class="std std-ref">Configuration</span></a>). If anything goes wrong, you’ll be able to visit this logfile and hopefully get enough
information to troubleshoot the problem.</p></li>
<li><p>Starting Benji with <code class="docutils literal notranslate"><span class="pre">--log-level</span> <span class="pre">DEBUG</span></code> will increase the log level on the console as well.</p></li>
<li><p>You should also monitor the status of existing backups with commands like <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">ls</span> <span class="pre">'status</span> <span class="pre">!=</span> <span class="pre">&quot;valid&quot;'</span></code>.
<em>Versions</em> with a status of <code class="docutils literal notranslate"><span class="pre">incomplete</span></code> are normal while a backup is in progress.</p></li>
<li><p>Benji also changes to process name to indicate what it is currently doing.</p></li>
</ul>
</div>
<div class="section" id="machine-output">
<span id="id2"></span><h3>Machine output<a class="headerlink" href="#machine-output" title="Permalink to this headline">¶</a></h3>
<p>Some commands can produce machine readable JSON output for usage in scripts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>INFO: $ benji -m ls
{
  &quot;versions&quot;: [
    {
      &quot;uid&quot;: 1,
      &quot;date&quot;: &quot;2019-09-27T18:05:21.936087Z&quot;,
      &quot;name&quot;: &quot;test&quot;,
      &quot;snapshot&quot;: &quot;&quot;,
      &quot;size&quot;: 692241,
      &quot;block_size&quot;: 4194304,
      &quot;storage_id&quot;: 1,
      &quot;status&quot;: &quot;valid&quot;,
      &quot;protected&quot;: false,
      &quot;bytes_read&quot;: 692241,
      &quot;bytes_written&quot;: 692241,
      &quot;bytes_dedup&quot;: 0,
      &quot;bytes_sparse&quot;: 0,
      &quot;duration&quot;: 0,
      &quot;labels&quot;: {
        &quot;label-1&quot;: &quot;bla&quot;,
        &quot;label-2&quot;: &quot;blub&quot;
      }
    }
  ],
  &quot;metadata_version&quot;: &quot;2.0.0&quot;
}
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Take care to put the <code class="docutils literal notranslate"><span class="pre">-m</span></code> between <code class="docutils literal notranslate"><span class="pre">benji</span></code> and <code class="docutils literal notranslate"><span class="pre">ls</span></code>.</p>
</div>
<p>All messages emitted by Benji are written to STDERR. In contrast the machine readable output is written to STDOUT.</p>
<p>Here’s a table of commands supporting machine readable output and their output:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 23%" />
<col style="width: 77%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Description of output</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ls</p></td>
<td><p>List of matching <em>versions</em></p></td>
</tr>
<tr class="row-odd"><td><p>backup</p></td>
<td><p>List of newly create <em>version</em></p></td>
</tr>
<tr class="row-even"><td><p>enforce</p></td>
<td><p>List of removed <em>versions</em></p></td>
</tr>
<tr class="row-odd"><td><p>scrub</p></td>
<td><p>List of scrubbed <em>versions</em> and of <em>versions</em> with errors</p></td>
</tr>
<tr class="row-even"><td><p>deep-scrub</p></td>
<td><p>List of scrubbed <em>versions</em> and of <em>versions</em> with errors</p></td>
</tr>
<tr class="row-odd"><td><p>batch-scrub</p></td>
<td><p>List of scrubbed <em>versions</em> and of <em>versions</em> with errors</p></td>
</tr>
<tr class="row-even"><td><p>batch-deep-scrub</p></td>
<td><p>List of scrubbed <em>versions</em> and of <em>versions</em> with errors</p></td>
</tr>
</tbody>
</table>
<p><a class="reference external" href="https://stedolan.github.io/jq/">jq</a> is an excellent tool for parsing this data and filtering out the bits you want.
Here’s a short example, but see the <code class="docutils literal notranslate"><span class="pre">scripts/</span></code> and <code class="docutils literal notranslate"><span class="pre">images/benji-k8s/scripts/</span></code> directories for more:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ benji -m ls | jq -r &#39;.versions[0].date&#39;
2018-06-07T12:51:19
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="container.html" class="btn btn-neutral float-right" title="Containerized Benji" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="statistics.html" class="btn btn-neutral float-left" title="Storage Statistics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017-2019, Lars Fenneberg, Daniel Kraft

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 


</body>
</html>