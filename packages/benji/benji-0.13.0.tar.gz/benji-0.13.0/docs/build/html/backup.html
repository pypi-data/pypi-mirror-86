

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Backup &mdash; Benji Backup 0.11.0+dirty documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/asciinema/asciinema-player.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/asciinema/asciinema-player.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Scrub" href="scrub.html" />
    <link rel="prev" title="Configuration" href="configuration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Benji Backup
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#fedora-27-and-up">Fedora 27 and up</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#opensuse">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#rhel-centos-7">RHEL/CentOS 7</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ubuntu-16-04">Ubuntu 16.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#common-to-all-distributions">Common to All Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#ceph-rbd-support">Ceph RBD Support</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#some-vocabulary">Some Vocabulary</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#backup">Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#deep-scrub-and-scrub">Deep Scrub and Scrub</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#restore">Restore</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#version-removal-and-cleanup">Version Removal and Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#configuration-file-location">Configuration File Location</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#top-level-configuration-directives">Top-level configuration directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-i-o-configurations">List of I/O Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-transform-configurations">List of Transform Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#list-of-storage-configurations">List of Storage Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#i-o-modules">I/O Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-file">I/O Module file</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-rbd">I/O Module rbd</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-rbdaio">I/O Module rbdaio</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#i-o-module-iscsi">I/O Module iscsi</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#transform-modules">Transform Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-zstd">Transform Module zstd</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-aes-256-gcm">Transform Module aes_256_gcm</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#transform-module-aes-256-gcm-ecc">Transform Module aes_256_gcm_ecc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#storage-modules">Storage Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#hmac">HMAC</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#read-cache">Read Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-file">Storage Module file</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-s3">Storage Module s3</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#storage-module-b2">Storage Module b2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#nbd">NBD</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#multiple-instance-installations">Multiple Instance Installations</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#simple-backup">Simple Backup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#versions">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#differential-backup">Differential Backup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#specifying-a-block-size">Specifying a block size</a></li>
<li class="toctree-l2"><a class="reference internal" href="#labeling-versions">Labeling <em>Versions</em></a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-hints-file">The Hints File</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scrub.html">Scrub</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#reasons-for-scrubbing">Reasons for Scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-methods">Scrubbing Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-and-checksum">Consistency and Checksum</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#using-the-backup-source">Using the Backup Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="scrub.html#consistency-only">Consistency Only</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#batch-scrubbing">Batch scrubbing</a></li>
<li class="toctree-l2"><a class="reference internal" href="scrub.html#scrubbing-failures">Scrubbing Failures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="restore.html">Restore</a><ul>
<li class="toctree-l2"><a class="reference internal" href="restore.html#restoring">Restoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="restore.html#restoring-without-a-database">Restoring without a database</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#nbd-server">NBD Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="restore.html#known-issues-with-nbd-client">Known Issues with nbd-client</a></li>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-only-mount">Read-Only Mount</a></li>
<li class="toctree-l3"><a class="reference internal" href="restore.html#read-write-mount">Read-Write Mount</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="restore.html#restoring-invalid-versions">Restoring Invalid <em>Versions</em></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="enforce.html">Retention Policy Enforcement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="enforce.html#policy-specification">Policy Specification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cleanup.html">Cleanup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#removing-old-versions">Removing old versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cleanup.html#id1">Cleanup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="statistics.html">Storage Statistics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="statistics.html#id1">Storage Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="statistics.html#space-usage-statistics">Space Usage Statistics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="administration.html">Administration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="administration.html#securing-version-metadata">Securing Version Metadata</a><ul>
<li class="toctree-l3"><a class="reference internal" href="administration.html#backups-and-exports">Backups and Exports</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#database-high-availability">Database High-Availability</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="administration.html#securing-block-data-on-storages">Securing Block Data on Storages</a></li>
<li class="toctree-l2"><a class="reference internal" href="administration.html#monitoring">Monitoring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="administration.html#general-advise">General Advise</a></li>
<li class="toctree-l3"><a class="reference internal" href="administration.html#machine-output">Machine output</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="container.html">Containerized Benji</a><ul>
<li class="toctree-l2"><a class="reference internal" href="container.html#images">Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="container.html#benji">benji</a></li>
<li class="toctree-l3"><a class="reference internal" href="container.html#benji-k8s">benji-k8s</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="container.html#helm-charts">Helm Charts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="container.html#id1">benji-k8s</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="filter_expressions.html">Filter Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="datalayout.html">Data Layout</a><ul>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#database-backend">Database Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="datalayout.html#block-storages">Block Storages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="support.html#issue-tracker">Issue Tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="support.html#security">Security</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="licenses.html">Licenses</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Benji Backup</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Backup</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/backup.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="backup">
<h1>Backup<a class="headerlink" href="#backup" title="Permalink to this headline">¶</a></h1>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>$ benji backup --help
usage: benji backup [-h] [-u VERSION_UID] [-s SNAPSHOT] [-r RBD_HINTS]
                    [-f BASE_VERSION_UID] [-b BLOCK_SIZE] [-l label]
                    [-S STORAGE]
                    source volume

positional arguments:
  source                Source URL
  volume                Volume name

optional arguments:
  -h, --help            show this help message and exit
  -u VERSION_UID, --uid VERSION_UID
                        Unique ID of created version (will be generated
                        automatically if not specified)
  -s SNAPSHOT, --snapshot SNAPSHOT
                        Snapshot name (e.g. the name of the RBD snapshot)
  -r RBD_HINTS, --rbd-hints RBD_HINTS
                        Hints in rbd diff JSON format
  -f BASE_VERSION_UID, --base-version BASE_VERSION_UID
                        Base version UID
  -b BLOCK_SIZE, --block-size BLOCK_SIZE
                        Block size in bytes
  -l label, --label label
                        Labels for this version (can be repeated)
  -S STORAGE, --storage STORAGE
                        Destination storage (if unspecified the default is
                        used)
</pre></div>
</div>
<div class="section" id="simple-backup">
<h2>Simple Backup<a class="headerlink" href="#simple-backup" title="Permalink to this headline">¶</a></h2>
<p>A backup can be initiated with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">backup</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ benji backup <span class="nv">$BACKUP_SOURCE</span> <span class="nv">$BACKUP_NAME</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">$BACKUP_SOURCE</span></code> should be replaced by a URI specifying the backup source.``$BACKUP_NAME`` specifies the name
given to the backup of this specific source and normally does not change when doing multiple backups of the same
source. Different backups of the same source are differentiated by their <em>version</em> UID.</p>
<p>Currently supported schemes for backup sources are <strong>file</strong> and <strong>rbd</strong>. So real-world examples would look like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ benji backup file:///var/lib/vms/database.img database
$ benji backup rbd:poolname/database@snapshot1 database
</pre></div>
</div>
</div>
<div class="section" id="versions">
<h2>Versions<a class="headerlink" href="#versions" title="Permalink to this headline">¶</a></h2>
<p>A backup at a specific point-in-time is called a <em>version</em>. Apart from a list of blocks a <em>version</em> has a number of
fields describing it:</p>
<ul class="simple">
<li><p><strong>date</strong>: Date and time of the backup</p></li>
<li><p><strong>uid</strong>: Unique identifier for this version (always starts with the letter <code class="docutils literal notranslate"><span class="pre">V</span></code> followed by a number with optional
leading zeros)</p></li>
<li><p><strong>name</strong>: Name as specified on the <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">backup</span></code> command line</p></li>
<li><p><strong>snapshot</strong>: Snapshot name as specified on the <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">backup</span></code> command line with the <code class="docutils literal notranslate"><span class="pre">--snapshot-name</span></code> option</p></li>
<li><p><strong>size</strong>: Size of the backed up image in bytes</p></li>
<li><p><strong>block_size</strong>: Block size in bytes</p></li>
<li><p><strong>valid</strong>: Validity of this version (either <code class="docutils literal notranslate"><span class="pre">valid</span></code>, <code class="docutils literal notranslate"><span class="pre">invalid</span></code>, or <code class="docutils literal notranslate"><span class="pre">incomplete</span></code>)</p></li>
<li><p><strong>protected</strong>: Boolean flag indicating if this version is protected from removal</p></li>
<li><p><strong>labels</strong>: List of label name, value pairs as specified on the <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">backup</span></code> command line with the <code class="docutils literal notranslate"><span class="pre">--label</span></code>
option or by using <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">label</span></code></p></li>
</ul>
<p>You can output this data with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ benji ls
    INFO: $ benji ls
+---------------------+-------------+------+----------+----------+------------+-------+-----------+------+
<span class="p">|</span>         date        <span class="p">|</span>     uid     <span class="p">|</span> name <span class="p">|</span> snapshot <span class="p">|</span>     size <span class="p">|</span> block_size <span class="p">|</span> valid <span class="p">|</span> protected <span class="p">|</span> tags <span class="p">|</span>
+---------------------+-------------+------+----------+----------+------------+-------+-----------+------+
<span class="p">|</span> <span class="m">2018</span>-06-07T12:51:19 <span class="p">|</span> V0000000001 <span class="p">|</span> <span class="nb">test</span> <span class="p">|</span>          <span class="p">|</span> <span class="m">41943040</span> <span class="p">|</span>    <span class="m">4194304</span> <span class="p">|</span>  True <span class="p">|</span>   False   <span class="p">|</span>      <span class="p">|</span>
+---------------------+-------------+------+----------+----------+------------+-------+-----------+------+
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>It is possible to filter the output of <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">ls</span></code> with a filter expression. See <a class="reference internal" href="filter_expressions.html#filter-expressions"><span class="std std-ref">Filter Expressions</span></a>.</p>
</div>
</div>
<div class="section" id="differential-backup">
<span id="id1"></span><h2>Differential Backup<a class="headerlink" href="#differential-backup" title="Permalink to this headline">¶</a></h2>
<p>Benji only backups changed blocks. It can do this in two different ways:</p>
<ol class="arabic simple">
<li><p><strong>By reading the whole image</strong>: Benji reads and calculates a checksum for each block. The checksum is then looked
up in the database. If a block with the same checksum is found, only a reference to this block is saved. Otherwise
a new block is created and saved to the storage.</p></li>
<li><p><strong>By using a hints file</strong>: The hints file is a JSON formatted list of (offset, size, usage) tuples (see
<a class="reference internal" href="#hints-file"><span class="std std-ref">The Hints File</span></a>). Each tuple indicates if a specific region of the image is used at all or if it has changed
since the last backup. The format of the hints file understood by Benji matches the output of
<code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">diff</span> <span class="pre">…</span> <span class="pre">--format=json</span></code>. If a hints file is specified Benji only reads and checksums blocks hinted at by the
hints file. The checksum is then again looked up in the database. If a block with the same checksum is found, only
a reference to this block is saved. Otherwise a new block is created and saved to the storage.
The hints file is passed via the <code class="docutils literal notranslate"><span class="pre">--rbd-hints</span></code> option to <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">backup</span></code>. It is not Ceph RBD specific per se and
could also be used in other scenarios like the backup of LVM snapshots.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Benji does <strong>forward-incremental backups</strong>. In contrast to other backup modes, there is no need to create
another full backup after the first one. From a restore standpoint all versions are full backups (sometimes
called a synthetic full backup).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If Benji detects that a backup source’s size has changed, Benji will assume that the image was extended at the
end. This is normally the case when you resize partitions or when extending logical volumes or Ceph RBD images.</p>
</div>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<div class="section" id="lvm-and-other-images">
<h4>LVM and other images<a class="headerlink" href="#lvm-and-other-images" title="Permalink to this headline">¶</a></h4>
<p>Day 1 (Initial Backup):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ lvcreate --size 1G --snapshot --name snap /dev/vg00/lvol1
$ benji backup file:///dev/vg00/snap lvol1
$ lvremove -y /dev/vg00/snap
</pre></div>
</div>
<p>Day 2..n (Differential Backups):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ lvcreate --size 1G --snapshot --name snap /dev/vg00/lvol1
$ benji backup file:///dev/vg00/snap lvol1
$ lvremove -y /dev/vg00/snap
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>With LVM snapshots, the snapshot volume increases in size as the origin volume changes. If the snapshot
is 100% full, it is lost and invalid. It is important to monitor the snapshot usage with the <code class="docutils literal notranslate"><span class="pre">lvs</span></code> command
to make sure the snapshot does not fill up completely. The <code class="docutils literal notranslate"><span class="pre">--size</span></code> parameter defines the space reserved for
changes during the snapshot’s existence. Snapshots of thin volumes don’t need the <code class="docutils literal notranslate"><span class="pre">--size</span></code> parameter, they use
the space available in the pool to keep track of changes. Also note that LVM does read-write-write for any
overwritten block while a snapshot exists. This may hurt your performance.</p>
</div>
</div>
<div class="section" id="ceph-rbd">
<h4>Ceph RBD<a class="headerlink" href="#ceph-rbd" title="Permalink to this headline">¶</a></h4>
<p>With Ceph RBD Ceph itself is able to calculate the changes between two snapshots. Since the <em>jewel</em> version of Ceph
this is a very fast process if the <em>fast-diff</em> feature is enabled. In this case only metadata has to be compared.</p>
<div class="section" id="manually">
<h5>Manually<a class="headerlink" href="#manually" title="Permalink to this headline">¶</a></h5>
<p>In this example, we will backup an RBD image called <code class="docutils literal notranslate"><span class="pre">vm1</span></code> which is in the pool <code class="docutils literal notranslate"><span class="pre">pool</span></code>.</p>
<ol class="arabic">
<li><p>Create an initial backup:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ rbd snap create pool/vm1@backup1
$ rbd diff --whole-object pool/vm1@backup1 --format<span class="o">=</span>json &gt; /tmp/vm1.diff
$ benji backup --snapshot-name backup1 --rbd-hints /tmp/vm1.diff rbd:pool/vm1@backup1 vm1
</pre></div>
</div>
</li>
<li><p>Create a differential backup:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ rbd snap create pool/vm1@backup2
$ rbd diff --whole-object pool/vm1@backup2 --from-snap backup1 --format<span class="o">=</span>json &gt; /tmp/vm1.diff

<span class="c1"># Delete old snapshot</span>
$ rbd snap rm pool/vm1@backup1

<span class="c1"># Identify the UID of the version corresponding to the last RBD snapshot</span>
$ benji ls <span class="s1">&#39;name == &quot;vm1&quot; and snapshot == &quot;backup1&quot;&#39;</span>

<span class="c1"># And backup (replace V001234567 with the version UID you identified in the last step)</span>
$ benji backup --snapshot-name backup2 --rbd-hints /tmp/vm1.diff --base-version V001234567 rbd:pool/vm1@backup2 vm1
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="automation">
<h5>Automation<a class="headerlink" href="#automation" title="Permalink to this headline">¶</a></h5>
<div class="section" id="bash">
<h6>Bash<a class="headerlink" href="#bash" title="Permalink to this headline">¶</a></h6>
<p>Benji includes an example Bash script <code class="docutils literal notranslate"><span class="pre">scripts/ceph.sh</span></code> which automates the process outlined in the last section.</p>
<p>The general workflow of this script is:</p>
<ul class="simple">
<li><p>When the backup of an RBD image is initiated, the latest RBD snapshot is looked up.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only RBD snapshots that begin the prefix <em>b-</em> are considered. All other snapshots are left alone. This makes
it possible to have other snapshots that will not be touched by Benji.</p>
</div>
<ul class="simple">
<li><p>If no RBD snapshot is found, an initial backup is performed.</p></li>
<li><p>If there is an RBD snapshot, Benji is asked if it has corresponding <em>version</em> of this snapshot. If not, an initial
backup is performed.</p></li>
<li><p>If Benji has a <em>version</em> of the snapshot, a hints file is created via
<code class="docutils literal notranslate"><span class="pre">rbd</span> <span class="pre">diff</span> <span class="pre">--whole-object</span> <span class="pre">&lt;new</span> <span class="pre">snapshot&gt;</span> <span class="pre">--from-snap</span> <span class="pre">&lt;old</span> <span class="pre">snapshot&gt;</span> <span class="pre">--format=json</span></code>.</p></li>
<li><p>After that Benji only backups the changes as listed in the hints file.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This alone won’t be enough to be on the safe side. The validity of the backup data needs to checked
regularly. Please refer to section <a class="reference internal" href="scrub.html#scrubbing"><span class="std std-ref">Scrub</span></a>.</p>
</div>
</div>
<div class="section" id="python">
<h6>Python<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h6>
<p>There is also a number of Python modules in the <code class="docutils literal notranslate"><span class="pre">benji.helpers</span></code> package. The modules are independent from the rest of
Benji’s Python modules and only call the command line interface of Benji.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">benji.helpers.ceph</span></code>: Implements the same functionality as the Bash scripts described in the previous section.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">benji.helpers.utils</span></code>: Utility functions used by other modules in the <code class="docutils literal notranslate"><span class="pre">benji.helpers</span></code> package.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">benji.helpers.settings</span></code>: Configuration variables used by other modules in the <code class="docutils literal notranslate"><span class="pre">benji.helpers</span></code> package derived from
environment variables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">benji.helpers.kubernetes</span></code>: Helper functions for interacting with Kubernetes (requires <code class="docutils literal notranslate"><span class="pre">kubectl</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">benji.helpers.prometheus</span></code>: Helper functions and metric definitions for pushing metrics to a Prometheus
<code class="docutils literal notranslate"><span class="pre">pushgateway</span></code></p></li>
</ul>
<p>Usage examples for these helpers can be found in <code class="docutils literal notranslate"><span class="pre">images/benji-k8s/bin</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to use them as the basis for your own scripts please make copies of the parts you need, so that
you are not affected by changes in future versions of Benji.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="specifying-a-block-size">
<h2>Specifying a block size<a class="headerlink" href="#specifying-a-block-size" title="Permalink to this headline">¶</a></h2>
<p>To perform a backup Benji splits up the image into equal sized blocks. <a class="footnote-reference brackets" href="#id3" id="id2">1</a></p>
<p>By default the block size specified in the configuration file is used. But the block size can also be set on the
command line on a <em>version</em> by <em>version</em> basis, but be aware that this will affect deduplication and increase space
usage.</p>
<p>One possible use case for different block sizes is backing up LVM volumes and Ceph images with the same Benji
installation. While for Ceph RBD four megabytes is usually the best size, LVM volumes might profit from a smaller
block size.</p>
<p>If you want to base a new version on an old version (as it can be the case when doing a differential backup) the block
size of the old and new version must match. Benji will terminate with an error if this is not the case.</p>
</div>
<div class="section" id="labeling-versions">
<h2>Labeling <em>Versions</em><a class="headerlink" href="#labeling-versions" title="Permalink to this headline">¶</a></h2>
<p>A <em>version</em> can have zero or more associated labels. A label consists of a label name and an optional label value. To
specify a label the <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">backup</span></code> command provides the command line switch <code class="docutils literal notranslate"><span class="pre">--label</span></code> which can be repeated
multiple times to set multiple labels at once.</p>
<blockquote>
<div><p>$ benji backup –label example.com/label=value –label example.com/label-2 rbd:cephstorage/test_vm test_vm</p>
</div></blockquote>
<p>If no label value is specified it is set to an empty string.</p>
<p>Later on it is possible to add, change or remove labels with <code class="docutils literal notranslate"><span class="pre">benji</span> <span class="pre">label</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ benji label V0000000001 example.com/label-1<span class="o">=</span>value-1 example.com/label-2
</pre></div>
</div>
<p>To remove a label specify its name followed by a dash (<code class="docutils literal notranslate"><span class="pre">-</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ benji label V0000000001 example.com/label-1-
</pre></div>
</div>
<p>It is no error to change or remove a label which already exists or which does not exist anymore respectively.</p>
</div>
<div class="section" id="the-hints-file">
<span id="hints-file"></span><h2>The Hints File<a class="headerlink" href="#the-hints-file" title="Permalink to this headline">¶</a></h2>
<p>Example of a hints file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[{</span><span class="s2">&quot;offset&quot;</span>:0,<span class="s2">&quot;length&quot;</span>:4194304,<span class="s2">&quot;exists&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>,
<span class="o">{</span><span class="s2">&quot;offset&quot;</span>:4194304,<span class="s2">&quot;length&quot;</span>:4194304,<span class="s2">&quot;exists&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>,
<span class="o">{</span><span class="s2">&quot;offset&quot;</span>:8388608,<span class="s2">&quot;length&quot;</span>:4194304,<span class="s2">&quot;exists&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>,
<span class="o">{</span><span class="s2">&quot;offset&quot;</span>:12582912,<span class="s2">&quot;length&quot;</span>:4194304,<span class="s2">&quot;exists&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>,
<span class="o">{</span><span class="s2">&quot;offset&quot;</span>:16777216,<span class="s2">&quot;length&quot;</span>:4194304,<span class="s2">&quot;exists&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>,
<span class="o">{</span><span class="s2">&quot;offset&quot;</span>:20971520,<span class="s2">&quot;length&quot;</span>:4194304,<span class="s2">&quot;exists&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>,
<span class="o">{</span><span class="s2">&quot;offset&quot;</span>:25165824,<span class="s2">&quot;length&quot;</span>:4194304,<span class="s2">&quot;exists&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>,
<span class="o">{</span><span class="s2">&quot;offset&quot;</span>:952107008,<span class="s2">&quot;length&quot;</span>:4194304,<span class="s2">&quot;exists&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}</span>
</pre></div>
</div>
<dl class="footnote brackets">
<dt class="label" id="id3"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p>Except the last block which may vary in length.</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="scrub.html" class="btn btn-neutral float-right" title="Scrub" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="configuration.html" class="btn btn-neutral float-left" title="Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2017-2019, Lars Fenneberg, Daniel Kraft

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 


</body>
</html>